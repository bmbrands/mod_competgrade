define("mod_competgrade/competgrade",["exports","core/ajax","core/notification","core/templates"],(function(_exports,_ajax,_notification,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JS for the CompetGrade Grading App UI.
   *
   * @module     mod_competgrade/competgrade
   * @copyright  2024 Bas Brands <bas@sonsbeekmedia.nl>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates);class CompetGrade{constructor(){this.gradingApp=document.querySelector('[data-region="grading-app"]'),this.competgrade=this.gradingApp.dataset.competgradeId,this.globalGrade=this.gradingApp.querySelector('[data-action="globalgrade"]'),this.globalComment=this.gradingApp.querySelector('[data-action="globalcomment"]'),this.userlist=[],this.currentUser=0,this.addEventListeners(),this.getData()}getUserList(){const request={methodname:"mod_competgrade_userlist",args:{competgrade:this.competgrade}},promise=_ajax.default.call([request])[0];return promise.fail(_notification.default.exception),promise}getUserComments(user){const request={methodname:"mod_competgrade_usercomments",args:{competgrade:this.competgrade,userid:user.id}},promise=_ajax.default.call([request])[0];return promise.fail(_notification.default.exception),promise}saveGrade(args){args.competgrade=this.competgrade,args.userid=this.currentUser.id;const request={methodname:"mod_competgrade_grade",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)}getComment(args){const request={methodname:"mod_competgrade_getcomment",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)}saveComment(args){args.competgrade=this.competgrade;const request={methodname:"mod_competgrade_comment",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)}deleteComment(args){const request={methodname:"mod_competgrade_deletecomment",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)}deleteGrade(args){args.competgrade=this.competgrade;const request={methodname:"mod_competgrade_deletegrade",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)}commentSavedMessage(commentid){const commentRegion=this.gradingApp.querySelector('[data-region="comment"][data-comment-id="'+commentid+'"]');if(!commentRegion)return;const savedMessage=commentRegion.closest('[data-region="commentwrapper"]').querySelector('[data-region="commentsaved"]');savedMessage&&(savedMessage.classList.remove("opacity-0"),setTimeout((()=>{savedMessage.classList.add("opacity-0")}),3e3))}addEventListeners(){this.globalGrade.addEventListener("change",(event=>{let value=event.target.value;const args={competgrade:this.competgrade,gradeid:event.target.dataset.gradeId,criterium:event.target.dataset.criteriumId};value&&""!=value?(args.grade=value,this.saveGrade(args).then((response=>{response.gradeid&&(event.target.dataset.gradeId=response.gradeid),this.currentUser.grade=value})).catch(_notification.default.exception)):this.deleteGrade(args)})),this.globalComment.addEventListener("input",(event=>{let value=event.target.value;const args={competgrade:this.competgrade,gradeid:event.target.dataset.gradeId,userid:this.currentUser.id,type:2,commenttitle:"Global comment",commenttext:value};event.target.dataset.commentId&&(args.commentid=event.target.dataset.commentId),value&&""!=value?(clearTimeout(this.commentTimeout),this.commentTimeout=setTimeout((()=>{args.commenttext=event.target.value,this.saveComment(args).then((response=>{response.commentid&&(event.target.dataset.commentId=response.commentid,this.commentSavedMessage(response.commentid))})).catch(_notification.default.exception)}),1e3)):event.target.dataset.commentId&&this.deleteComment({commentid:event.target.dataset.commentId})})),document.addEventListener("click",(event=>{if(event.target.closest('[data-action="prevuser"]')){event.preventDefault();let index=this.userlist.indexOf(this.currentUser);if(0==index)return;this.setCurrentUser(this.userlist[index-1]),this.render()}if(event.target.closest('[data-action="nextuser"]')){event.preventDefault();let index=this.userlist.indexOf(this.currentUser);if(index==this.userlist.length-1)return;this.setCurrentUser(this.userlist[index+1]),this.render()}}))}setCurrentUser(user){this.currentUser=user,this.globalGrade.dataset.gradeId=user.gradeid,this.globalGrade.value=user.grade}render(){this.renderUserNavigation(),this.renderComments(),this.getGlobalComment()}renderUserNavigation(){const navigation=this.gradingApp.querySelector('[data-region="user-navigation"]'),context={user:this.currentUser};_templates.default.render("mod_competgrade/usernavigation",context).then((html=>{navigation.innerHTML=html})).catch(_notification.default.exception);const header=this.gradingApp.querySelector('[data-region="user-header"]');_templates.default.render("mod_competgrade/userheader",context).then((html=>{header.innerHTML=html})).catch(_notification.default.exception)}async renderComments(){const comments=await this.getUserComments(this.currentUser),commentsRegion=this.gradingApp.querySelector('[data-region="comments"]');comments&&_templates.default.render("mod_competgrade/comments",comments).then((html=>{commentsRegion.innerHTML=html})).catch(_notification.default.exception)}getGlobalComment(){const comment=this.gradingApp.querySelector('[data-action="globalcomment"]'),args={competgrade:this.competgrade,userid:this.currentUser.id,type:2};this.getComment(args).then((response=>{response.commentid?(comment.value=response.commenttext,comment.dataset.commentId=response.commentid):(comment.value="",comment.dataset.commentId="")})).catch(_notification.default.exception)}async getData(){const response=await this.getUserList();response.userlist&&(this.userlist=response.userlist,this.currentUser=response.userlist[0],this.setCurrentUser(this.currentUser),this.render())}}var _default={init:()=>{new CompetGrade}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=competgrade.min.js.map